datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
}

enum FamilyPlan {
  FREE
  PRO
}

enum MembershipRole {
  OWNER
  MEMBER
}

enum TransactionType {
  EXPENSE
  INCOME
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model User {
  id            String        @id @default(cuid())
  name          String
  email         String        @unique
  passwordHash  String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  memberships   Membership[]
  ownedFamilies Family[]      @relation("FamilyOwner")
  sessions      Session[]
  transactions  Transaction[]
  subscription  Subscription?
}

model Family {
  id         String        @id @default(cuid())
  name       String
  currency   String
  plan       FamilyPlan    @default(FREE)
  createdAt  DateTime      @default(now())
  ownerId    String
  owner      User          @relation("FamilyOwner", fields: [ownerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  memberships Membership[]
  invites    Invite[]
  transactions Transaction[]

  @@index([ownerId])
}


model Subscription {
  id        String              @id @default(cuid())
  userId    String              @unique
  plan      SubscriptionPlan
  status    SubscriptionStatus
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Membership {
  id        String          @id @default(cuid())
  userId    String
  familyId  String
  role      MembershipRole
  joinedAt  DateTime        @default(now())

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, familyId])
  @@index([userId])
  @@index([familyId])
}

model Invite {
  id        String          @id @default(cuid())
  token     String          @unique
  familyId  String
  role      MembershipRole  @default(MEMBER)
  expiresAt DateTime
  createdAt DateTime        @default(now())
  usedAt    DateTime?

  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model Transaction {
  id         String          @id @default(cuid())
  familyId   String
  userId     String
  type       TransactionType
  amount     Int
  currency   String
  description String?
  occurredAt DateTime
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  family     Family          @relation(fields: [familyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([familyId])
  @@index([userId])
  @@index([occurredAt])
}
